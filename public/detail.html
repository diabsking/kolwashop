<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Détail du produit</title>
   <style>
  /* Réinitialisation des styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/* Style global du body */
body {
  font-family: 'Poppins', sans-serif;
  background-color: #fff;
  color: #333;
  padding: 20px;
}

/* Grille des produits */
#productGrid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

/* Style d'un produit dans la grille */
.product-item {
  background: #fff;
  border: 1px solid #ddd;
  padding: 15px;
  text-align: center;
  border-radius: 8px;
  transition: box-shadow 0.3s ease;
  cursor: pointer;
}
.product-item:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}
.product-item img {
  max-width: 100%;
  height: auto;
  border-radius: 4px;
  margin-bottom: 10px;
}

/* Section de détail d'un produit */
#detailSection {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 30px;
}
#detailSection img {
  max-width: 100%;
  height: auto;
  border-radius: 4px;
  margin-bottom: 20px;
}
#detailSection h2 {
  margin-bottom: 15px;
}
#detailSection p {
  margin-bottom: 10px;
  line-height: 1.6;
}
#detailSection video {
  width: 100%;
  max-height: 400px;
  margin-bottom: 20px;
}

/* Galerie d'images complémentaires */
#imageCarousel {
  display: flex;
  overflow-x: auto;
  gap: 10px;
  margin-bottom: 20px;
}
#imageCarousel img {
  width: 100px;
  height: 100px;
  object-fit: cover;
  border-radius: 4px;
}

/* Section des avis */
#reviewSection {
  margin-bottom: 20px;
}
.review-item {
  border-top: 1px solid #ddd;
  padding: 10px 0;
}
.review-item p {
  margin-bottom: 5px;
}

/* Boutons généraux */
button {
  padding: 10px 15px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.3s ease;
}

/* Boutons spécifiques de la section détail */
#prevProduct,
#nextProduct,
#contactSellerButton,
#addToCartButton,
#returnToProductsButton {
  background: #28a745;
  color: #fff;
  margin: 5px;
}
#prevProduct:hover,
#nextProduct:hover,
#contactSellerButton:hover,
#addToCartButton:hover,
#returnToProductsButton:hover {
  background: #218838;
}

/* Grille des produits similaires */
#similarGrid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-top: 30px;
}
.similar-item {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 10px;
  text-align: center;
  transition: box-shadow 0.3s ease;
  cursor: pointer;
}
.similar-item:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}
.similar-item img {
  width: 100%;
  height: auto;
  border-radius: 4px;
  margin-bottom: 10px;
}
.similar-item .product-name {
  font-weight: bold;
  margin-bottom: 5px;
}
.similar-item .product-price {
  color: #28a745;
  margin-bottom: 10px;
}
.similar-item .add-to-cart {
  padding: 8px 12px;
  background: #007bff;
  border: none;
  color: #fff;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.3s ease;
}
.similar-item .add-to-cart:hover {
  background: #0069d9;
}

/* Notification */
#notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #28a745;
  color: #fff;
  padding: 15px 20px;
  border-radius: 4px;
  opacity: 0;
  transition: opacity 0.5s ease;
  z-index: 1000;
}
#notification.show {
  opacity: 1;
}

/* Adaptations responsives */
@media (max-width: 768px) {
  #productGrid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }
  #similarGrid {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  }
}
</style>
</head>
<body>
  <!-- Zone de la grille des produits -->
  <div id="productGrid">
    <!-- Contenu de la grille des produits -->
  </div>
  
  <!-- Section de détail d'un produit (cachée par défaut) -->
  <div id="detailSection" style="display: none;">
    <button id="returnToProductsButton">Retour aux produits</button>
    <img id="detailImage" src="" alt="">
    <h2 id="detailName"></h2>
    <p id="detailDescription"></p>
    <p id="detailPrice"></p>
    <p id="detailSeller"></p>
    <!-- Informations complémentaires -->
    <p id="detailDiscount"></p>
    <p id="detailBrand"></p>
    <p id="detailSKU"></p>
    <p id="detailWeight"></p>
    <p id="detailDimensions"></p>
    <p id="detailShippingCost"></p>
    <p id="detailEstimatedDelivery"></p>
    <p id="detailReturnPolicy"></p>
    <p id="detailWarranty"></p>
    <p id="detailCreatedAt"></p>
    <p id="detailOrders"></p>
    <p id="detailViews"></p>
    <p id="detailAddToCart"></p>
    <!-- Vidéo (si disponible) -->
    <video id="detailVideo" controls style="display: none;"></video>
    <!-- Galerie d'images complémentaires -->
    <div id="imageCarousel"></div>
    <!-- Section des avis -->
    <div id="reviewSection"></div>
    <!-- Navigation entre produits -->
    <button id="prevProduct">Produit précédent</button>
    <button id="nextProduct">Produit suivant</button>
    <!-- Bouton pour contacter le vendeur -->
    <button id="contactSellerButton" style="display: none;">Contacter le vendeur</button>
    <!-- Bouton pour ajouter au panier -->
    <button id="addToCartButton" onclick="addToCart(currentProduct.productName, currentProduct.price, currentProduct.description, currentProduct.imageUrl, currentProduct.sellerEmail, this)">Ajouter au panier</button>
  </div>
  
  <!-- Section des produits similaires -->
  <div id="similarGrid"></div>
  
  <!-- Notification -->
  <div id="notification" class="notification"></div>
  
  <script>
    // Variables globales
    let allProducts = [];
    let cartCount = 0;
    let currentProduct = null;

    // Fonction pour ajouter un produit au panier
    function addToCart(name, price, description, imageUrl, sellerEmail, button) {
      button.textContent = "Ajouté!";
      button.disabled = true;
      button.style.backgroundColor = "#28a745";
      fetch('/api/add-to-cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, price, description, imageUrl, sellerEmail })
      })
      .then(response => response.ok ? response.json() : Promise.reject('Erreur API'))
      .then(data => {
        if (data.success) {
          cartCount++;
          updateCartCount();
        } else {
          throw new Error("Erreur lors de l'ajout au panier");
        }
      })
      .catch(err => {
        console.error("Échec lors de l'ajout au panier:", err);
        button.textContent = "Réessayer";
        button.disabled = false;
      });
      showNotification(`${name} ajouté au panier!`);
    }

    // Mise à jour du compteur du panier
    function updateCartCount() {
      document.getElementById("cartCount").textContent = cartCount;
    }

    // Affichage d'une notification temporaire
    function showNotification(message) {
      const notification = document.getElementById("notification");
      if (!notification) return;
      notification.textContent = message;
      notification.classList.add("show");
      setTimeout(() => notification.classList.remove("show"), 3000);
    }

    // Affichage de la vue détail d'un produit
    function showProductDetailView(product) {
      currentProduct = product;
      
      // Réinitialiser le bouton "Ajouter au panier"
      const addToCartButton = document.getElementById("addToCartButton");
      if (addToCartButton) {
        addToCartButton.textContent = "Ajouter au panier";
        addToCartButton.disabled = false;
        addToCartButton.style.backgroundColor = ""; // Réinitialisation du style si nécessaire
      }

      // Masquer la grille des produits et afficher la section de détail
      document.getElementById("productGrid").style.display = "none";
      document.getElementById("detailSection").style.display = "block";

      // Mise à jour des informations de base
      document.getElementById("detailImage").src = product.imageUrl || "";
      document.getElementById("detailImage").alt = product.productName || "Image du produit";
      document.getElementById("detailName").innerText = product.productName || "Nom inconnu";
      document.getElementById("detailDescription").innerText = product.description || "";
      document.getElementById("detailPrice").innerText = product.price ? `${product.price.toFixed(2)} FCFA` : "";
      document.getElementById("detailSeller").innerText = product.sellerEmail || "Inconnu";

      // Informations complémentaires
      if (document.getElementById("detailDiscount"))
        document.getElementById("detailDiscount").innerText = product.discount ? product.discount + (product.discountType === "percentage" ? " %" : " FCFA") : "Aucune remise";
      if (document.getElementById("detailBrand"))
        document.getElementById("detailBrand").innerText = product.brand || "Non spécifiée";
      if (document.getElementById("detailSKU"))
        document.getElementById("detailSKU").innerText = product.sku || "N/A";
      if (document.getElementById("detailWeight"))
        document.getElementById("detailWeight").innerText = product.weight ? product.weight + " kg" : "Non spécifié";
      if (document.getElementById("detailDimensions") && product.dimensions) {
        const { length, width, height } = product.dimensions;
        document.getElementById("detailDimensions").innerText = `${length || 0} x ${width || 0} x ${height || 0} cm`;
      }
      if (document.getElementById("detailShippingCost"))
        document.getElementById("detailShippingCost").innerText = product.shippingCost ? product.shippingCost + " FCFA" : "Gratuit";
      if (document.getElementById("detailEstimatedDelivery"))
        document.getElementById("detailEstimatedDelivery").innerText = product.estimatedDelivery ? product.estimatedDelivery + " jours" : "Non précisé";
      if (document.getElementById("detailReturnPolicy"))
        document.getElementById("detailReturnPolicy").innerText = product.returnPolicy || "Non spécifiée";
      if (document.getElementById("detailWarranty"))
        document.getElementById("detailWarranty").innerText = product.warranty || "Aucune";

      if (document.getElementById("detailCreatedAt") && product.createdAt)
        document.getElementById("detailCreatedAt").innerText = new Date(product.createdAt).toLocaleDateString();
      if (document.getElementById("detailOrders") && product.orders !== undefined)
        document.getElementById("detailOrders").innerText = product.orders;
      if (document.getElementById("detailViews") && product.views !== undefined)
        document.getElementById("detailViews").innerText = product.views;
      if (document.getElementById("detailAddToCart") && product.addToCart !== undefined)
        document.getElementById("detailAddToCart").innerText = product.addToCart;

      // Gestion de la vidéo du produit
      if (product.videoUrl) {
        document.getElementById("detailVideo").src = product.videoUrl;
        document.getElementById("detailVideo").style.display = "block";
      } else {
        document.getElementById("detailVideo").style.display = "none";
      }

      // Affichage de la galerie d'images complémentaires
      const imageCarousel = document.getElementById("imageCarousel");
      if (imageCarousel) {
        imageCarousel.innerHTML = "";
        if (Array.isArray(product.images)) {
          product.images.forEach(imageUrl => {
            const img = document.createElement("img");
            img.src = imageUrl;
            img.alt = product.productName;
            imageCarousel.appendChild(img);
          });
        }
      }

      // Affichage des produits similaires
      const similarProducts = allProducts.filter(p => {
        return (p._id !== product._id) && 
          (p.detectedCategory === product.detectedCategory || aiDetectCategory(p) === aiDetectCategory(product));
      });
      displaySimilarProducts(similarProducts);

      // Affichage des avis du produit
      const reviewSection = document.getElementById("reviewSection");
      if (reviewSection) reviewSection.innerHTML = "";
      if (Array.isArray(product.reviews)) {
        product.reviews.forEach(review => {
          const div = document.createElement("div");
          div.className = "review-item";
          div.innerHTML = `<p>${review.comment}</p><p>${review.rating} ★</p>`;
          reviewSection.appendChild(div);
        });
      }

      // Boutons de navigation (produit suivant/précédent)
      const nextBtn = document.getElementById("nextProduct");
      if (nextBtn) {
        nextBtn.onclick = function() {
          const currentIndex = allProducts.findIndex(p => p._id === currentProduct._id);
          const nextProduct = allProducts[(currentIndex + 1) % allProducts.length];
          showProductDetailView(nextProduct);
        };
      }
      const prevBtn = document.getElementById("prevProduct");
      if (prevBtn) {
        prevBtn.onclick = function() {
          const currentIndex = allProducts.findIndex(p => p._id === currentProduct._id);
          const prevProduct = allProducts[(currentIndex - 1 + allProducts.length) % allProducts.length];
          showProductDetailView(prevProduct);
        };
      }
      // Bouton "Retour aux produits"
      document.getElementById("returnToProductsButton").addEventListener("click", hideDetailSection);
      
      // Afficher le bouton pour contacter le vendeur
      const contactSellerButton = document.getElementById("contactSellerButton");
      if (contactSellerButton) contactSellerButton.style.display = "block";

      loadReviews(product._id);
    }

    // Fonction pour afficher les produits similaires dans la vue détail
    function displaySimilarProducts(products) {
      const similarGrid = document.getElementById("similarGrid");
      if (!similarGrid) return;
      similarGrid.innerHTML = "";
      if (products.length === 0) {
        similarGrid.innerHTML = "<p>Aucun produit similaire trouvé.</p>";
        return;
      }
      products.forEach(prod => {
        const div = document.createElement("div");
        div.className = "similar-item";
        div.innerHTML = `
          <img src="${prod.imageUrl}" alt="${prod.productName}">
          <div class="product-name">${prod.productName}</div>
          <div class="product-price">${prod.price} FCFA</div>
          <button class="add-to-cart" onclick="addToCart('${prod.productName}', ${prod.price}, '${prod.description}', '${prod.imageUrl}', '${prod.sellerEmail}', this)">Ajouter au panier</button>
        `;
        // Navigation vers le détail en cliquant sur l'élément
        div.addEventListener("click", function() {
          showProductDetailView(prod);
        });
        similarGrid.appendChild(div);
      });
    }

    // Exposition de certaines fonctions pour utilisation inline
    window.showProductDetailView = showProductDetailView;
    window.hideDetailSection = hideDetailSection;
    window.orderProduct = orderProduct;
    window.contactSeller = function() {
      const messageInput = document.getElementById("contactSellerMessage");
      const message = messageInput ? messageInput.value : "";
      if (!message.trim()) {
        alert("Veuillez saisir votre message.");
        return;
      }
      alert("Message envoyé au vendeur : " + message);
      if (messageInput) messageInput.value = "";
    };
    window.filterProductsByKeyword = filterProductsByKeyword;
  </script>
</body>
</html>